---
title: "Ant colony"
author: "Jan Lennartz & Andrei Chirita"
date: "11/22/2020"
output: pdf_document
---
```{r,echo=FALSE,results='hide'}
library(curl)
library(igraph)
library(ggplot2)
library(stats)
source("helpers.R")
library(stargazer)
```
\newpage
\tableofcontents
\newpage

# Introduction

Ant colonies have a complex and fascinating social structure that may bring answers to a multitude of scientific questions. Usually the nest are organized in a stratified manner with a queen at the center and numerous workers doing tasks needed for the upkeep of the colony. The study for which the data we worked on was collected sought to understand the social structure of *Camponotus fellah* ants, what are the groups inside the colonies and what factors define them. 

## The data

The original data of the study consist of more than 9 million observed interactions between ants collected for 41 days from ants belonging to 6 colonies. For our project we decided to work on ..... 

### Preliminary data exploration

In the following section we will show how the data is structured for a single colony in a single day (namely day 17, colony 1). We will start by loading the data using the get_graph function that we built previously.

```{r}
g <- get_graph(colony = 1, day = 17)
```
Next we will have a look at the vertices of the graph, as can be seen there are 99 of them in this graph.

```{r}
vcount(g)
```
Next we displayed the number of edges, as can be seen there are over 3300 edges. Thus in day 17, for the first colony there were over 3342 interactions between 99 ants.
```{r}
ecount(g)
```
```{r}
str(vertex.attributes(g))
```
Each vertex has also a set of attributes like:

* Several attributes that are useful for understanding the interactions of the studied

* Attributes that register the visits of the ant to important places of the colony (like the brood or the nest entrance)

* The groups fitted by the authors of the study

* The age of the ant (measured in days)

* The body size of the ant

```{r, echo=FALSE}
library(scales)
G <- g
G_Grouped = G

## Add edges with high weight between all nodes in the same group
for(i in unique(V(G)$group)) {
  GroupV = which(V(G)$group == i)
  G_Grouped = add_edges(G_Grouped, combn(GroupV, 2), attr=list(weight=10))
} 

## Now create a layout based on G_Grouped
set.seed(123)
LO = layout_with_fr(G_Grouped)

V(G)$group <- as.factor(V(G)$group)
degs <- rescale(degree(G), c(0,1))
## Use the layout to plot the original graph
plot(G, vertex.label = NA, vertex.color=V(G)$group, layout=LO, vertex.size = degs * 13)
legend('topleft',legend=c("NA", "Cleaners", "Foragers", "Nurses", "Queen"), col='black', pch=21, pt.bg=categorical_pal(5))
```

```{r,echo=FALSE}
foragers <- induced_subgraph(g, which(V(g)$group=="F"))
nurses <- induced_subgraph(g, which(V(g)$group=="N"))
cleaners <- induced_subgraph(g, which(V(g)$group=="C"))

groups <- list(Foragers=foragers, Nurses=nurses, Cleaners=cleaners)

par(mfrow=c(1,3))

lapply(seq_along(groups), function(u){plot(groups[[u]],main = paste(names(groups)[u]),vertex.label=NA)})
```

As we can see the foragers and cleaners groups contain more ants than the nurses group and they also contains more interactions.

## The original paper

The original paper was written by: Danielle P. Mersch, Alessandro Crespi and Laurent Keller and explores questions related how can we separate ant colonies into groups and what makes ants change the group they belong to. During their study they found 3 main groups based on the interactions between ants and concluded that age is the main factor that determines ants to change the group they are part of. All colonies studied had 4-years old queens and between 122 and 192 workers per colony. Each ant was marked and followed individually and an interaction between two ants were defined by the fact that "the front end of one ant was located within thetrapezoidal shape representing the other ant".

## Our questions

The goal of this work is to conduct the given data set w.r.t. various aspects. Furthermore, a validation of the key results of the original paper is carried out. For this a sample colony is chosen on a given day. On this network the analysis is to be done. Certain properties will be evaluated over multiple days when required.

We will first explore the network in a descriptive manner. This includes characteristics like degree distribution, density, diameter and more. In the second step we have a closer look at the groups. First, we validate that the three groups are a valid proposal for the given network. This is done by running a clustering algorithm on the network to identify the groups which will be compared to the labeled groupings. Second, we investigate how frequently ants communicate within groups and compare this to the level of communication between groups. We answer the question how fast information can be spread in the network and compare this to the result of the paper. Additionally, we calculate the centrality of specific ant or groups (e.g. the queen) w.r.t. different measures. Furthermore, we review several properties of the ants and their correlation with the groups (e.g. age, size).

#  Descriptive Statistics of the network

As we noted above the data we are going to use for our analysis refers to the movements of the ants of the first colony in day 17 of the study. Thus the graph has 99 vertices and 3342 edges. We must also note that the graph is connected.

## For the general network

```{r,echo=FALSE,results='hide'}
g <- get_graph(colony = 1, day = 17)
```

```{r,echo=FALSE,results='hide'}
degrees<-data.frame(degree=degree(g))
ggplot(degrees)+aes(x=degree)+geom_histogram(binwidth = 10)+ggtitle("Histogram of the degrees")
```
```{r,echo=FALSE}
print("Distribution of the degrees: ")
paste("[0-30] : ",length(degrees[degrees[,1]<=30,]))
paste("(30-60] : ",length(degrees[degrees[,1]<=60,]))
paste("(60-90] : ",length(degrees[degrees[,1]<=90&degrees[,1]>60,]))
paste(">90 : ",length(degrees[degrees[,1]>90,]))
paste("min : ",min(degrees))
paste("max : ",max(degrees))
```

Most nodes have a rather higher degree (between 60 and 90) and there are some nodes with a lower value of the degree, thus we can infer that most ants had a higher number of contacts while some ants had less frequent meetings. There is a small number of nodes that has a very high degree (90 or over 90), they represent ants that had a lot of encounters. We must also note that no ant had less than 33 encounters.

### Average Path Length and Diameter

The average path length can show how connected the analyzed network is.In the case of our graph the value is aproximatively 1,31. Another measure of the connectivity of the graph is its diameter (the maximum of the series of shortest paths), the value of the indicator is: 5
```{r}
average.path.length(g)
diameter(g)
```

### Measures of Centrality

```{r}
deg <- centralization.degree(g)
deg <- data.frame(index=factor(1:length(deg$res),levels=1:length(deg$res)),deg=deg$res[order(deg$res, decreasing = TRUE)])
ggplot(deg)+aes(y=deg,x=index)+geom_col(width=1)+
  theme(axis.title.x = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())
?geom_col
```

```{r}
deg <- centralization.closeness(g)
deg <- data.frame(index=factor(1:length(deg$res),levels=1:length(deg$res)),closeness_centrality=deg$res[order(deg$res, decreasing = TRUE)])
ggplot(deg)+aes(y=closeness_centrality,x=index)+geom_col(width=1)+
  theme(axis.title.x = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())
```

```{r}
deg <- centralization.betweenness(g)
deg <- data.frame(index=factor(1:length(deg$res),levels=1:length(deg$res)),betweenes_centrality=deg$res[order(deg$res, decreasing = TRUE)])
ggplot(deg)+aes(y=betweenes_centrality,x=index)+geom_col(width=1)+
  theme(axis.title.x = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())
```
In regard to betweeness centrality we can observe that one ant ranks far over the others, thus we can conclude that there is one ant that has a very central role in the network a conclusion we couldn't draw based on the other measures of centrality.



```{r}
deg <- centralization.evcent(g)
deg <- data.frame(index=factor(1:length(deg$vector),levels=1:length(deg$vector)),eigenvalue_centrality=deg$vector[order(deg$vector, decreasing = TRUE)])
ggplot(deg)+aes(y=eigenvalue_centrality,x=index)+geom_col(width=1)+
  theme(axis.title.x = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())
```
The eigenvalue centrality presents a decreasing structure although it is a smoother decrease compared to the one of the betweenes centrality, in this case we can find no node that is much more "central" that the others.

```{r}
deg <- page.rank(g)
deg <- data.frame(index=factor(1:length(deg$vector),levels=1:length(deg$vector)),page_rank=deg$vector[order(deg$vector, decreasing = TRUE)])
ggplot(deg)+aes(y=page_rank,x=index)+geom_col(width=1)+
  theme(axis.title.x = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())
```
The page rank of the nodes of the graph presents a structure in which there are several dominating nodes that have a much higher rank than the others.

### Clustering Coefficient

```{r}
transitivity(g)
```
The clustering coefficient of the whole graph is 0.77, we will compare it to those of the groups in the next sections.

## By group

Before looking at the following summary statistics per group it is important to know about the size of each group. There are 50 ants in the group foragers, 27 cleaners and 18 are nurses. This means the following results need to be considered under the fact of this unequal distribution of group members.

### Histogram and Density

The foragers have a rather wider spread of degrees compared to the other two groups. Most of them have a degree greater than 40. The other two groups are distributed very homogeneously. It is notable though that there is a hierarchy of degrees starting from the low degree group of nurses to the midrange group of cleaners over to the higher degree group of foragers.

```{r echo=FALSE}
par(mfrow=c(1,3))
tmp <- lapply(names(groups), function(u) hist(degree(groups[[u]]), freq = FALSE, 
                                       main = paste("Histogram of", u), xlab = "Degree"))
```

```{r}
par(mfrow=c(1,3))
max(degree(groups[[1]]))
length(degree_distribution(groups[[1]]))
tmp <- lapply(groups, function(u){
  deg_dist <- data.frame(value = degree_distribution(u), deg=1:(max(degree(u))+1))
  ggplot(deg_dist) + aes(x=deg, y=value) + geom_point()
})
tmp
```


### Connectivity and Components

All separate groups are connected and thus, each of them form a big component.
```{r}
lapply(groups, is_connected)
```


### Average Path Length and Diameter

The average path length can be an indicator of how connected a network is. Here the foragers and the cleaners have a similar average path length of around 1.12. In comparison the nurses have an average path length of 1.09, a bit smaller. All three groups are very well connected because most ants can reach any other ant of the same group in less than 2 steps. Moreover the groups have smaller average path lengths than the overall graph which suggests that the proposed grouping does indeed lead to more coherent groups. The diameter is the longest shortest path in a network and differs quite a bit in this network. The foragers have a diameter of 11, compared to the nurses with 7 and the cleaners with 4. This might be an indicator of a lower connection level in the group of the foragers. There exists at least one ant who has to go over 11 other ants in order to connect with another specially chosen ant. This is quite extreme considering the average path length is 1.12 in this group.
```{r}
lapply(groups, average.path.length)
lapply(groups, diameter)
```
### Centrality Measures

We have considered many different centrality measures. Most of them have shown a rather homogeneous distribution, meaning there was no distinction possible between central nodes and less central nodes. For each group the following centrality measures were decreasing smoothly without any particular exceptional occurrences: degree centrality, closeness centrality and eigenvalue centrality. While this can indicate that in general there are no real distinct central nodes in the network we can still try to find some special ants w.r.t. other centrality measures.

```{r, echo=FALSE, results='hide'}
# par(mfrow=c(1,3))
# deg <- lapply(groups, centralization.degree)
# deg <- lapply(deg, function(u) u$res[order(u$res, decreasing = TRUE)])
# tmp <- lapply(names(deg), function(u) barplot(deg[[u]], main = paste("Degree centrality", u)))
# 
# deg_data<-lapply(1:3,function(u){deg[[u]]<-data.frame(degree=deg[[u]],group=names(deg)[u])})
# deg_data<-do.call(rbind,deg_data)
# tmp <- ggplot(deg_data)+aes(group,degree)+geom_boxplot()
```


```{r, echo=FALSE, results='hide'}
# par(mfrow=c(1,3))
# clos <- lapply(groups, centralization.closeness)
# clos <- lapply(clos, function(u) u$res[order(u$res, decreasing = TRUE)])
# tmp <- lapply(names(clos), function(u) barplot(clos[[u]], main = paste("Closeness centrality", u)))
# clos_data<-lapply(1:3,function(u){clos[[u]]<-data.frame(closeness=clos[[u]],group=names(clos)[u])})
# clos_data<-do.call(rbind,clos_data)
# ggplot(clos_data)+aes(group,closeness)+geom_boxplot()
```

```{r, echo=FALSE, results='hide'}
# par(mfrow=c(1,3))
# eig <- lapply(groups, centralization.evcent)
# eig <- lapply(eig, function(u) u$vector[order(u$vector, decreasing = TRUE)])
# tmp <- lapply(names(eig), function(u) barplot(eig[[u]], main = paste("Eigenvalue centrality", u)))
```

Betweenness centrality: Here we see actually a decreasing structure in all three groups. Some ants lie on the paths connecting other ants. And some ants are rather unimportant in the network.  

```{r}
par(mfrow=c(1,3))
betw <- lapply(groups, centralization.betweenness)
betw <- lapply(betw, function(u) u$res[order(u$res, decreasing = TRUE)])
tmp <- lapply(names(betw), function(u) barplot(betw[[u]], main = paste("Betweenness centrality", u)))
```

Pagerank: Here we can see that the foragers have a few ants who are very important w.r.t to this centrality measure. This could indicate that these ants are consulted by many other ants who themselves are consulted by many ants. 
```{r}
par(mfrow=c(1,3))
pagr <- lapply(groups, page.rank)
pagr <- lapply(pagr, function(u) u$vector[order(u$vector, decreasing = TRUE)])
tmp <- lapply(names(pagr), function(u) barplot(pagr[[u]], main = paste("Pagerank", u)))
```

### Clustering Coefficient
Very similar results again for the clustering coefficient. All groups are very highly connected.
```{r}
lapply(groups, transitivity)
```

## K-means check

### Preparing the data
```{r}
atributes<-vertex.attributes(g)
str(atributes)
to_cluster<-data.frame(
  id=atributes$name,
  group=atributes$group,
  i_queen=atributes$nb_interaction_queen,
  i_forag=atributes$nb_interaction_foragers,
  i_clean=atributes$nb_interaction_cleaners,
  i_nurse=atributes$nb_interaction_nurses,
  v_rubbish=atributes$visits_to_rubbishpile,
  v_entr=atributes$visits_to_nest_entrance,
  v_brood=atributes$visits_to_brood,
  foraging=atributes$nb_foraging_events,
  age=atributes$`age(days)`,
  size=atributes$body_size
)
to_cluster<-na.omit(to_cluster)
str(to_cluster)
nrow(to_cluster)
```

```{r}
to_cluster2<-scale(to_cluster[,3:ncol(to_cluster)])
models<-lapply(1:10,function(i){kmeans(to_cluster2,i)})
sum_withinn<-do.call(rbind,lapply(1:length(models),function(i){models[[i]]$tot.withinss}))
sum_withinn<-data.frame(index=1:nrow(sum_withinn),name=rep("withiness",nrow(sum_withinn)),value=sum_withinn)
sum_between<-do.call(rbind,lapply(1:length(models),function(i){models[[i]]$betweenss}))
sum_between<-data.frame(index=1:nrow(sum_between),name=rep("betweenes",nrow(sum_between)),value=sum_between)
#sum_total<-data.frame(index=1:nrow(sum_between),
#                   name=rep("total error",nrow(sum_between)),
#                   value=sum_between$value+sum_withinn$value)
to_plot<-rbind(sum_withinn,sum_between)
ggplot(to_plot)+aes(x=index,y=value,colour=name)+geom_point()+geom_line()
```

```{r}
model3<-models[[3]]
to_cluster3<-data.frame(to_cluster,found_labels=model3$cluster)
table(to_cluster3$group,to_cluster3$found_labels)
```
From the results above we may infer that the foragers group may have been misclasified and that there are a lot of foragers that present similar behaviour to that of the cleaners.
```{r}
model4<-models[[4]]
to_cluster4<-data.frame(to_cluster,found_labels=model4$cluster)
table(to_cluster4$group,to_cluster4$found_labels)
```



### Atempt 2
```{r}
atributes<-vertex.attributes(g)
str(atributes)
to_cluster<-data.frame(
  id=atributes$name,
  group=atributes$group,
  i_queen=atributes$nb_interaction_queen,
  i_forag=atributes$nb_interaction_foragers,
  i_clean=atributes$nb_interaction_cleaners,
  i_nurse=atributes$nb_interaction_nurses,
  v_rubbish=atributes$visits_to_rubbishpile,
  v_entr=atributes$visits_to_nest_entrance,
  v_brood=atributes$visits_to_brood,
  foraging=atributes$nb_foraging_events
)
to_cluster<-na.omit(to_cluster)
str(to_cluster)
nrow(to_cluster)
```


```{r}
to_cluster2<-scale(to_cluster[,3:ncol(to_cluster)])
models<-lapply(1:10,function(i){kmeans(to_cluster2,i)})
sum_withinn<-do.call(rbind,lapply(1:length(models),function(i){models[[i]]$tot.withinss}))
sum_withinn<-data.frame(index=1:nrow(sum_withinn),name=rep("withiness",nrow(sum_withinn)),value=sum_withinn)
sum_between<-do.call(rbind,lapply(1:length(models),function(i){models[[i]]$betweenss}))
sum_between<-data.frame(index=1:nrow(sum_between),name=rep("betweenes",nrow(sum_between)),value=sum_between)
#sum_total<-data.frame(index=1:nrow(sum_between),
#                   name=rep("total error",nrow(sum_between)),
#                   value=sum_between$value+sum_withinn$value)
to_plot<-rbind(sum_withinn,sum_between)
ggplot(to_plot)+aes(x=index,y=value,colour=name)+geom_point()+geom_line()
```

```{r}
model3<-models[[3]]
to_cluster3<-data.frame(to_cluster,found_labels=model3$cluster)
table(to_cluster3$group,to_cluster3$found_labels)
```

Stil the same problem




















